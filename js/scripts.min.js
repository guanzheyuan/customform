function handleSaveLayout() {
    var e = $(".demo").html();
    if (e != window.demoHtml) {
        saveLayout();
        window.demoHtml = e
    }
}

function handleJsIds() {
    handleModalIds();
    handleAccordionIds();
    handleCarouselIds();
    handleTabsIds()
}

function handleAccordionIds() {
    var e = $(".demo #myAccordion");
    var t = randomNumber();
    var n = "panel-" + t;
    var r;
    e.attr("id", n);
    e.find(".panel").each(function (e, t) {
        r = "panel-element-" + randomNumber();
        $(t).find(".panel-title").each(function (e, t) {
            $(t).attr("data-parent", "#" + n);
            $(t).attr("href", "#" + r)
        });
        $(t).find(".panel-collapse").each(function (e, t) {
            $(t).attr("id", r)
        })
    })
}

function handleCarouselIds() {
    var e = $(".demo #myCarousel");
    var t = randomNumber();
    var n = "carousel-" + t;
    e.attr("id", n);
    e.find(".carousel-indicators li").each(function (e, t) {
        $(t).attr("data-target", "#" + n)
    });
    e.find(".left").attr("href", "#" + n);
    e.find(".right").attr("href", "#" + n)
}

function handleModalIds() {
    var e = $(".demo #myModalLink");
    var t = randomNumber();
    var n = "modal-container-" + t;
    var r = "modal-" + t;
    e.attr("id", r);
    e.attr("href", "#" + n);
    e.next().attr("id", n)
}

function handleTabsIds() {
    var e = $(".demo #myTabs");
    var t = randomNumber();
    var n = "tabs-" + t;
    e.attr("id", n);
    e.find(".tab-pane").each(function (e, t) {
        var n = $(t).attr("id");
        var r = "panel-" + randomNumber();
        $(t).attr("id", r);
        $(t).parent().parent().find("a[href=#" + n + "]").attr("href", "#" + r)
    })
}

function randomNumber() {
    return randomFromInterval(1, 1e6)
}

function randomFromInterval(e, t) {
    return Math.floor(Math.random() * (t - e + 1) + e)
}

function gridSystemGenerator() {
    $(".lyrow .preview input").bind("keyup", function () {
        var e = 0;
        var t = "";
        var n = false;
        var r = $(this).val().split(" ", 12);
        $.each(r, function (r, i) {
            if (!n) {
                if (parseInt(i) <= 0) n = true;
                e = e + parseInt(i);
                t += '<div class="col-md-' + i + ' column"></div>'
            }
        });
        if (e == 12 && !n) {
            $(this).parent().next().children().html(t);
            $(this).parent().prev().show()
        } else {
            $(this).parent().prev().hide()
        }
    })
}

function configurationElm(e, t) {
    $(".demo").delegate(".configuration > a", "click", function (e) {
        e.preventDefault();
        var t = $(this).parent().next().next().children();
        $(this).toggleClass("active");
        t.toggleClass($(this).attr("rel"))
    });
    $(".demo").delegate(".configuration .dropdown-menu a", "click", function (e) {
        e.preventDefault();
        var t = $(this).parent().parent();
        var n = t.parent().parent().next().next().children();
        t.find("li").removeClass("active");
        $(this).parent().addClass("active");
        var r = "";
        t.find("a").each(function () {
            r += $(this).attr("rel") + " "
        });
        t.parent().removeClass("open");
        n.removeClass(r);
        n.addClass($(this).attr("rel"))
    })
}

function removeElm() {
    $(".demo").delegate(".remove", "click", function (e) {
        e.preventDefault();
        $(this).parent().remove();
        if (!$(".demo .lyrow").length > 0) {
            clearDemo()
        }
    })
}

function clearDemo() {
    $(".demo").empty()
}

function removeMenuClasses() {
    $("#menu-layoutit li button").removeClass("active")
}

function changeStructure(e, t) {
    $("#download-layout ." + e).removeClass(e).addClass(t)
}

function cleanHtml(e) {
    $(e).parent().append($(e).children().html())
}

function downloadLayoutSrc() {
    var e = "";
    $("#download-layout").children().html($(".demo").html());
    var t = $("#download-layout").children();
    t.find(".preview, .configuration, .drag, .remove").remove();
    t.find(".lyrow").addClass("removeClean");
    t.find(".box-element").addClass("removeClean");
    t.find(".lyrow .lyrow .lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".removeClean").remove();
    $("#download-layout .column").removeClass("ui-sortable");
    $("#download-layout .row-fluid").removeClass("clearfix").children().removeClass("column");
    if ($("#download-layout .container").length > 0) {
        changeStructure("row-fluid", "row")
    }
    formatSrc = $.htmlClean($("#download-layout").html(), {
        format: true,
        allowedAttributes: [
            ["id"],
            ["class"],
            ["data-toggle"],
            ["data-target"],
            ["data-parent"],
            ["role"],
            ["data-dismiss"],
            ["aria-labelledby"],
            ["aria-hidden"],
            ["data-slide-to"],
            ["data-slide"],
            ["orgtype"],
			["fieldname"],
			["orgname"],
			["orgvalue"],
			["orgtype"],
			["orgwidth"],
			["orgheight"],
			["isrequired"],
			["title"],
			["orgCol"],
			["labelCol"]
        ]
    });
    $("#download-layout").html(formatSrc);
    $("#downloadModal textarea").empty();
    $("#downloadModal textarea").val(formatSrc)
}
var currentDocument = null;
var timerSave = 2e3;
var demoHtml = $(".demo").html();
$(window).resize(function () {
    $("body").css("min-height", $(window).height() - 90);
    $(".demo").css("min-height", $(window).height() - 160)
});
$(document).ready(function () {
    $("body").css("min-height", $(window).height() - 90);
    $(".demo").css("min-height", $(window).height() - 160);
    $(".demo, .demo .column").sortable({
        connectWith: ".column",
        opacity: .35,
        handle: ".drag"
    });
    $(".sidebar-nav .lyrow").draggable({
        connectToSortable: ".demo",
        helper: "clone",
        handle: ".drag",
        drag: function (e, t) {
            t.helper.width(400)
        },
        stop: function (e, t) {
            $(".demo .column").sortable({
                opacity: .35,
                connectWith: ".column"
            })
        }
    });
    $(".sidebar-nav .box").draggable({
        connectToSortable: ".column",
        helper: "clone",
        handle: ".drag",
        drag: function (e, t) {
            t.helper.width(400)
        },
        stop: function () {
            handleJsIds()
        }
    });
    $("[data-target=#downloadModal]").click(function (e) {
        e.preventDefault();
        downloadLayoutSrc()
    });
    $("#download").click(function () {
        downloadLayout();
        return false
    });
    $("#downloadhtml").click(function () {
        downloadHtmlLayout();
        return false
    });
    $("#edit").click(function () {
        $("body").removeClass("devpreview sourcepreview");
        $("body").addClass("edit");
        removeMenuClasses();
        $(this).addClass("active");
        return false
    });
    $("#clear").click(function (e) {
        e.preventDefault();
        clearDemo()
    });
    $("#devpreview").click(function () {
        $("body").removeClass("edit sourcepreview");
        $("body").addClass("devpreview");
        removeMenuClasses();
        $(this).addClass("active");
        return false
    });
    $("#sourcepreview").click(function () {
        $("body").removeClass("edit");
        $("body").addClass("devpreview sourcepreview");
        removeMenuClasses();
        $(this).addClass("active");
        return false
    });
    $(".nav-header").click(function () {
        $(".sidebar-nav .boxes, .sidebar-nav .rows").hide();
        $(this).next().slideDown()
    });
    var layouteditor = '';
    $('body.edit .demo').on("click","[data-target=#editorLayout],[data-target=#editorTitle],[data-target=#editorInputModal]",function(e) {
        /**布局绘制  start*/
        layouteditor = $(this).parent().parent().find('.view');
        window.layoutEditor = layouteditor;
        /**布局绘制  end*/
        /**标题  start*/
        var titleEdit = $(this).parent().parent().parent().find('.view');
        window.titleEdit = titleEdit;
        /**标题  end*/
        var domType = $($(this).parent().parent().parent().find('.view').children().children()).attr('type');
        var dom = $(this).parent().parent().parent().find('.view').children().children();
        window.domClick = dom;
        if('text'==domType){
            $("#editorInputModal input[name=fieldname]").val(dom.attr('fieldname'));
			$("#editorInputModal input[name=orgname]").val(dom.attr('orgname'));
			$("#editorInputModal input[name=orgvalue]").val(dom.attr('value'));
            $("#editorInputModal .isRequired").find("option[value='"+dom.attr('isRequired')+"']").prop("selected",true);
            $("#editorInputModal .orgtype").find("option[value='"+dom.attr('orgtype')+"']").prop("selected",true);
        }
    });
    $(".savecontent").click(function(){
        var nameFlag = $(this).data("name");
        var dom = window.domClick;
        var div = dom.parent();
        if('data-input' == nameFlag){
            var serializeArray = $('#editorInputModal #inputForm').serializeArray();
            for(var i = 0;i<serializeArray.length;i++){
                if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				if('orgvalue' == serializeArray[i].name){
					$(dom).attr('value',serializeArray[i].value);
				}
				if('orgtype' == serializeArray[i].name){
					$(dom).attr('orgtype',serializeArray[i].value);
                }
                if('isRequired' == serializeArray[i].name){
					if('Y' == serializeArray[i].value){
						$(div).addClass('has-error');
					}else if('N' == serializeArray[i].value){
						$(div).removeClass('has-error');
					}
				}
                $(dom).attr(serializeArray[i].name,serializeArray[i].value);
            }
            $("#editorInputModal").modal('hide');  //手动关闭
        }
    });
    $(".saveTitle").click(function(e){
        var _titleEdit = window.titleEdit;
        var _textareaVal = $("#editorTitle .title").val();
        if(undefined!=_textareaVal && ''!=_textareaVal){
            $(_titleEdit.children().children()).text(_textareaVal);
            $("#editorTitle").modal('hide');  //手动关闭
        }else{
            $("#editorTitle .topinfo .info").html('请输入标题内容');
            $("#editorTitle .topinfo").removeClass('hide');
        }
       
    });
    $(".saveLayout").click(function(e){
        var _layouteditor = window.layoutEditor;
        var layoutCol = $("#editorLayout .layoutCol").val();
        var inputDom = $("#editorLayout .ratio input");
        if(layoutCol <= 12){
            var _result = 0;
            var _strResult='';
            for(var i = 0;i<inputDom.length;i++){
                _result+=parseInt($(inputDom[i]).val());
                _strResult+=$(inputDom[i]).val()+',';
            }
            if(_result <= 12){
                var _div='';
                var resultArr = _strResult.split(',');
                for(var i = 0;i<resultArr.length;i++){
                    if('' != resultArr[i]){
                        _div +='<div class="col-md-'+resultArr[i]+' column ui-sortable"></div>';
                    }
                }
                if(_result < 12){
                    var _remain = 12 - _result;
                    _div+='<div class="col-md-'+_remain+' column ui-sortable"></div>';
                }
                _layouteditor.children().html(_div);
                $(".demo .column").sortable({
                    opacity: .35,
                    connectWith: ".column"
                })
                $("#editorLayout").modal('hide');  //手动关闭
            }else{
                $(".topinfo .info").html('您输入的总比例'+_result+',已超出范围!');
                $("#editorLayout .topinfo").removeClass('hide');
            }
        }else{
            $("#editorLayout .topinfo .info").html('您输入了'+layoutCol+'列,已超出范围!');
            $("#editorLayout .topinfo").removeClass('hide');
        }

    })
    $("#editorLayout .layoutCol").bind("input propertychange",function(event){
        var fistInput = '<input type="number" class="form-control " style="width:7%;" value="1" min="1" max="12" step="1" >';
        var twoInput =  '<input type="number" class="form-control modal-input-number"  value="1" min="1" max="12" step="1" >';
        var appendInput = '<input type="number" class="form-control modal-input-numberNext"  value="1" min="1" max="12" step="1" >';
        var col = $(this).val();
        if(col <= 12){
            if(col ==1){
                $("#editorLayout .ratio").html(fistInput);
            }else if(col ==2){
                $("#editorLayout .ratio").html(fistInput+twoInput);
            }else if(col ==3){
                $("#editorLayout .ratio").html(fistInput+twoInput+appendInput);
            }else if(col == 4){
                var _appendInput = '';
                for(var i = 0;i<4-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==5){
                var _appendInput = '';
                for(var i = 0;i<5-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==6){
                var _appendInput = '';
                for(var i = 0;i<6-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==7){
                var _appendInput = '';
                for(var i = 0;i<7-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==8){
                var _appendInput = '';
                for(var i = 0;i<8-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==9){
                var _appendInput = '';
                for(var i = 0;i<9-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==10){
                var _appendInput = '';
                for(var i = 0;i<10-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==11){
                var _appendInput = '';
                for(var i = 0;i<11-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==12){
                var _appendInput = '';
                for(var i = 0;i<12-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }
            
        }
    });
    removeElm();
    configurationElm();
    gridSystemGenerator();
    setInterval(function () {
        handleSaveLayout()
    }, timerSave)
})