function handleSaveLayout() {
    var e = $(".demo").html();
    if (e != window.demoHtml) {
        saveLayout();
        window.demoHtml = e
    }
}

function handleJsIds() {
    handleModalIds();
    handleAccordionIds();
    handleCarouselIds();
    handleTabsIds()
}

function handleAccordionIds() {
    var e = $(".demo #myAccordion");
    var t = randomNumber();
    var n = "panel-" + t;
    var r;
    e.attr("id", n);
    e.find(".panel").each(function (e, t) {
        r = "panel-element-" + randomNumber();
        $(t).find(".panel-title").each(function (e, t) {
            $(t).attr("data-parent", "#" + n);
            $(t).attr("href", "#" + r)
        });
        $(t).find(".panel-collapse").each(function (e, t) {
            $(t).attr("id", r)
        })
    })
}

function handleCarouselIds() {
    var e = $(".demo #myCarousel");
    var t = randomNumber();
    var n = "carousel-" + t;
    e.attr("id", n);
    e.find(".carousel-indicators li").each(function (e, t) {
        $(t).attr("data-target", "#" + n)
    });
    e.find(".left").attr("href", "#" + n);
    e.find(".right").attr("href", "#" + n)
}

function handleModalIds() {
    var e = $(".demo #myModalLink");
    var t = randomNumber();
    var n = "modal-container-" + t;
    var r = "modal-" + t;
    e.attr("id", r);
    e.attr("href", "#" + n);
    e.next().attr("id", n)
}

function handleTabsIds() {
    var e = $(".demo #myTabs");
    var t = randomNumber();
    var n = "tabs-" + t;
    e.attr("id", n);
    e.find(".tab-pane").each(function (e, t) {
        var n = $(t).attr("id");
        var r = "panel-" + randomNumber();
        $(t).attr("id", r);
        $(t).parent().parent().find("a[href=#" + n + "]").attr("href", "#" + r)
    })
}

function randomNumber() {
    return randomFromInterval(1, 1e6)
}

function randomFromInterval(e, t) {
    return Math.floor(Math.random() * (t - e + 1) + e)
}

function gridSystemGenerator() {
    $(".lyrow .preview input").bind("keyup", function () {
        var e = 0;
        var t = "";
        var n = false;
        var r = $(this).val().split(" ", 12);
        $.each(r, function (r, i) {
            if (!n) {
                if (parseInt(i) <= 0) n = true;
                e = e + parseInt(i);
                t += '<div class="col-md-' + i + ' column"></div>'
            }
        });
        if (e == 12 && !n) {
            $(this).parent().next().children().html(t);
            $(this).parent().prev().show()
        } else {
            $(this).parent().prev().hide()
        }
    })
}

function configurationElm(e, t) {
    $(".demo").delegate(".configuration > a", "click", function (e) {
        e.preventDefault();
        var t = $(this).parent().next().next().children();
        $(this).toggleClass("active");
        t.toggleClass($(this).attr("rel"))
    });
    $(".demo").delegate(".configuration .dropdown-menu a", "click", function (e) {
        e.preventDefault();
        var t = $(this).parent().parent();
        var n = t.parent().parent().next().next().children();
        t.find("li").removeClass("active");
        $(this).parent().addClass("active");
        var r = "";
        t.find("a").each(function () {
            r += $(this).attr("rel") + " "
        });
        t.parent().removeClass("open");
        n.removeClass(r);
        n.addClass($(this).attr("rel"))
    })
}

function removeElm() {
    $(".demo").delegate(".remove", "click", function (e) {
        e.preventDefault();
        $(this).parent().remove();
        if (!$(".demo .lyrow").length > 0) {
            clearDemo()
        }
        var $demo = $(".demo");
        var optionHtml='<option value=" ">请选择</option>';
        var optionMap;
        var labelArr = [];
        var $demo = $(".demo");
        $demo.find('label').each(function(e){
            if(undefined != $(this).attr('id') && undefined != $(this).attr('title')){
                optionMap = {value:'',text:''};
                optionHtml +='<option value="'+$(this).attr('id')+'" >'+$(this).attr('title')+'</option>';
                optionMap.value = $(this).attr('id');
                optionMap.text = $(this).attr('title');
                labelArr.push(optionMap);
            }
        });
        window.labelArr = labelArr;
        $("#editorInputModal select[name=orgname]").html(optionHtml);
        $("#editorSelectModal select[name=orgname]").html(optionHtml);
        $("#editorTextareaModal select[name=orgname]").html(optionHtml);
        $("#editorRadioModal select[name=orgname]").html(optionHtml);
        $("#editorCheckboxModal select[name=orgname]").html(optionHtml);
        $("#editorDateTimeModal select[name=orgname]").html(optionHtml);
    });
}

function clearDemo() {
    $(".demo").empty()
}

function removeMenuClasses() {
    $("#menu-layoutit li button").removeClass("active")
}

function changeStructure(e, t) {
    $("#download-layout ." + e).removeClass(e).addClass(t)
}

function cleanHtml(e) {
    $(e).parent().append($(e).children().html())
}
var layoutHtml;
function downloadLayoutSrc() {
    var e = "";
    $("#download-layout").children().html($(".demo").html());
    var t = $("#download-layout").children();
    t.find(".preview, .configuration, .drag, .remove").remove();
    t.find(".lyrow").addClass("removeClean");
    t.find(".box-element").addClass("removeClean");
    t.find(".lyrow .lyrow .lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".lyrow .removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".removeClean").each(function () {
        cleanHtml(this)
    });
    t.find(".removeClean").remove();
    $("#download-layout .column").removeClass("ui-sortable");
    $("#download-layout .row-fluid").removeClass("clearfix").children().removeClass("column");
    if ($("#download-layout .container").length > 0) {
        changeStructure("row-fluid", "row")
    }
    formatSrc = $.htmlClean($("#download-layout").html(), {
        format: true,
        allowedAttributes: [
            ["id"],
            ["class"],
            ["data-toggle"],
            ["data-target"],
            ["data-parent"],
            ["role"],
            ["data-dismiss"],
            ["aria-labelledby"],
            ["aria-hidden"],
            ["data-slide-to"],
            ["data-slide"],
            ["orgtype"],
			["fieldname"],
			["orgname"],
			["orgvalue"],
			["orgtype"],
			["orgwidth"],
			["orgheight"],
			["isrequired"],
			["title"],
			["orgCol"],
            ["labelCol"],
            ['type'],
            ['col']
        ]
    });
    $("#download-layout").html(formatSrc);
    $("#downloadModal textarea").empty();
    $("#downloadModal textarea").val(formatSrc);
    layoutHtml = formatSrc;
}
function strimgTurnDom(txt){
	try 
    {
     xmlDoc=new ActiveXObject("Microsoft.HTMLDOM");
     xmlDoc.async="false";
     xmlDoc.loadXML(txt);
     alert("ie");
     return(xmlDoc);
    }
  catch(e)
    {
        try //Firefox, Mozilla, Opera, etc.
          {
            parser=new DOMParser();
            xmlDoc=parser.parseFromString(txt,"text/html");
            return(xmlDoc);
          }
        catch(e) {alert(e.message)}
    }
  return(null);
}
function loadUEditor(id){
    var formEditor = UE.getEditor(id, {
        toolleipi: true,//是否显示，设计器的 toolbars
        textarea: id,
        initialFrameHeight:300,
        //这里可以选择自己需要的工具按钮名称,此处仅选择如下五个
        toolbars: [[
            'fullscreen',
            'source', '|',
            'undo',
            'redo', '|',
            'bold',
            'italic',
            'underline',
            'fontborder',
            'strikethrough',
            'removeformat', '|',
            'forecolor',
            'backcolor',
            'insertorderedlist',
            'insertunorderedlist', '|',
            'fontfamily',
            'fontsize', '|',
            'indent', '|',
            'justifyleft',
            'justifycenter',
            'justifyright',
            'justifyjustify', '|',
            'link', 'unlink', '|',
            'horizontal',
            'spechars',
            'insertimage', '|',
            'inserttable',
            'deletetable',
            'mergecells',
            'splittocells'
        ]],
    });
}
function UEditorAddListener(id){
    UE.getEditor(id).addListener("click", function (type, event) {
        window.UEditorId = UE.getEditor(id).key;
        window.UEditor = UE.getEditor(id);
        window.domClick = event;
        console.log();
        if('text' == event.target.type){
            window.isUEditor = true;
            $('#editorInputTableModal').modal('show');
            $("#editorInputTableModal input[name=fieldname]").val($(event.target).attr("fieldname"));
            $("#editorInputTableModal input[name=orgname]").val($(event.target).attr("orgname"));
			$("#editorInputTableModal input[name=orgvalue]").val($(event.target).attr("value"));
            $("#editorInputTableModal .isRequired").find("option[value='"+$(event.target).attr("isRequired")+"']").prop("selected",true);
            $("#editorInputTableModal .orgtype").find("option[value='"+$(event.target).attr("orgtype")+"']").prop("selected",true);
        }else if('select' == $(event.target).attr('type')){
            window.isUEditor = true;
            $('#editorSelectTableModal').modal('show');
            $("#editorSelectTableModal input[name=fieldname]").val($(event.target).attr('fieldname'));
            $("#editorSelectTableModal input[name=orgname]").val($(event.target).attr('orgname'));
            $("#editorSelectTableModal .isRequired").find("option[value='"+$(event.target).attr('isRequired')+"']").prop("selected",true);
			var optionHtml = ' ';
            var index = 0;
            console.log($(event.target));
			$($(event.target)).find("option").each(function(){
				optionHtml += '<tr id="'+index+'"><td>'+$(this).eq(0).html()+'</td><td>'+$(this).eq(0).val()+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
				index++;
			});
			$("#editorSelectTableModal table tbody").html(optionHtml);
        }else if('textarea' == $(event.target).attr('type')){
            window.isUEditor = true;
            $('#editorTextareaTableModal').modal('show');
            $("#editorTextareaTableModal input[name=fieldname]").val($(event.target).attr('fieldname'));
            $("#editorTextareaTableModal input[name=orgname]").val($(event.target).attr('orgname'));
             $("#editorTextareaTableModal .isRequired").find("option").prop("selected",false);
             $("#editorTextareaTableModal .isRequired").find("option[value='"+$(event.target).attr('isRequired')+"']").prop("selected",true);
        }
        else{
            window.isUEditor = false;
        }
     });
}
var currentDocument = null;
var timerSave = 2e3;
var demoHtml = $(".demo").html();
$(window).resize(function () {
    $("body").css("min-height", $(window).height() - 90);
    $(".demo").css("min-height", $(window).height() - 160)
});
$(document).ready(function () {
    $("body").css("min-height", $(window).height() - 90);
    $(".demo").css("min-height", $(window).height() - 160);
    $(".demo, .demo .column").sortable({
        connectWith: ".column",
        opacity: .35,
        handle: ".drag"
    });
    $(".sidebar-nav .lyrow").draggable({
        connectToSortable: ".demo",
        helper: "clone",
        handle: ".drag",
        drag: function (e, t) {
            t.helper.width(400)
        },
        stop: function (e, t) {
            $(".demo .column").sortable({
                opacity: .35,
                connectWith: ".column"
            });
            if($(".demo #formEditor").length > 0 ){
                var UEditorId = "formEditor_"+Math.floor(Math.random()*1000);
                $(".demo #formEditor").attr('id',UEditorId);
                loadUEditor(UEditorId);
                UEditorAddListener(UEditorId);
            }
        }
    });
    $(".sidebar-nav .box").draggable({
        connectToSortable: ".column",
        helper: "clone",
        handle: ".drag",
        drag: function (e, ui) {
            var sourceElement = $(ui.helper.context);
            ui.helper.width(400)
        },
        stop: function (e,ui) {
            var $demo = $('.demo');
            $demo.find('label,input,select,textarea').each(function(e){
                var htmlDom = $(this).parent().parent().parent().parent();
                var classArr = htmlDom.attr('class').split(' ');
                var col = $(this).attr("col");
                if(undefined == col){
                    var colArr = classArr[0].split('-');
                    $(this).attr("col",colArr[2]);
                }
            });
            handleJsIds()
        }
    });
    $("[data-target=#downloadModal]").click(function (e) {
        e.preventDefault();
        downloadLayoutSrc()
    });
    $("[data-target=#toJsonModal]").click(function (e) {
        e.preventDefault();
        downloadLayoutSrc();
        var labelDom = strimgTurnDom(layoutHtml).querySelectorAll('label');
        var inputDom = strimgTurnDom(layoutHtml).querySelectorAll('input[type=text]');
		var selectDom = strimgTurnDom(layoutHtml).querySelectorAll('select');
		var textareaDom = strimgTurnDom(layoutHtml).querySelectorAll('textarea');
		var inputRadioDom = strimgTurnDom(layoutHtml).querySelectorAll('input[type=radio]');
		var inputCheckBoxDom = strimgTurnDom(layoutHtml).querySelectorAll('input[type=checkbox]');
		var inputTimeBoxDom = strimgTurnDom(layoutHtml).querySelectorAll('input[type=date],[type=time],[type=datetime-local],[type=month],[type=week]');
        var fromEle = {
			formId:1,
			formName:'test_1',
			formElements:[]
        }
        var elementList = [];
        var formInputElements;
        //输入框组合
		if(inputDom.length > 0){
			for(var i  = 0;i<inputDom.length;i++){
				console.log(inputDom[i]);
				formInputElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:'',
				}
				formInputElements.eleType = 'Input';
				formInputElements.name = inputDom[i].attributes.name == undefined ?'':inputDom[i].attributes.name.value;
				formInputElements.required = inputDom[i].attributes.isrequired == undefined?'':inputDom[i].attributes.isrequired.value == true;
                formInputElements.value = inputDom[i].attributes.value ==undefined?'':inputDom[i].attributes.value.value;
                formInputElements.contentGridCol = inputDom[i].attributes.col == undefined?'':inputDom[i].attributes.col.value;
                if(' '!=inputDom[i].attributes.orgname.value){
                    for(var j = 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == inputDom[i].attributes.orgname.value){
                            formInputElements.label = window.labelArr[j].text;
                            formInputElements.labelGridCol = $("#"+inputDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                elementList.push(formInputElements);
            }
        }
        var formSelectElements;
        if(selectDom.length > 0){
			for(var i  = 0;i<selectDom.length;i++){
				formSelectElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:'',
					eleInfo:[]
				}
				formSelectElements.eleType = 'Select';
				formSelectElements.name = selectDom[i].attributes.name == undefined ?'':selectDom[i].attributes.name.value;
				formSelectElements.contentGridCol = selectDom[i].attributes.col == undefined?'':selectDom[i].attributes.col.value;
                if(' '!=selectDom[i].attributes.orgname.value){
                    for(var j = 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == selectDom[i].attributes.orgname.value){
                            formSelectElements.label = window.labelArr[j].text;
                            formSelectElements.labelGridCol = $("#"+selectDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                if(selectDom[i].options.length > 0){
					var option;
					var eleInfo;
					for(var j = 0;j<selectDom[i].options.length;j++){
						eleInfo  = {
							value:'',
							content:''
						}
						option = selectDom[i].options[j];
						eleInfo.value = option.value;
						eleInfo.content = option.text;
						formSelectElements.eleInfo.push(eleInfo);
					}
				}
				elementList.push(formSelectElements)
			}
        }
        var formTextareaElements;
		if(textareaDom.length > 0){
			for(var i  = 0;i<textareaDom.length;i++){
				formTextareaElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:'',
				}
				formTextareaElements.eleType = 'Textarea';
				formTextareaElements.name = textareaDom[i].attributes.name == undefined ?'':textareaDom[i].attributes.name.value;
				formTextareaElements.value = textareaDom[i].attributes.value ==undefined?'':textareaDom[i].attributes.value.value;
				formTextareaElements.required = textareaDom[i].attributes.isrequired == undefined?'':textareaDom[i].attributes.isrequired.value == true;
				formTextareaElements.contentGridCol = textareaDom[i].attributes.col == undefined?'':textareaDom[i].attributes.col.value;
                if(' '!=textareaDom[i].attributes.orgname.value){
                    for(var j = 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == textareaDom[i].attributes.orgname.value){
                            formTextareaElements.label = window.labelArr[j].text;
                            formTextareaElements.labelGridCol = $("#"+textareaDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                elementList.push(formTextareaElements);
			}
        }
        var formRadioElements;
		if(inputRadioDom.length > 0 ){
			for(var i  = 0;i<inputRadioDom.length;i++){
				formRadioElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:''
				}
				formRadioElements.eleType = 'radio';
				formRadioElements.name = inputRadioDom[i].attributes.name == undefined ?'':inputRadioDom[i].attributes.name.value;
				//formRadioElements.label = inputRadioDom[i].attributes.title == undefined?'':inputRadioDom[i].attributes.title.value;
				//formRadioElements.value = inputRadioDom[i].attributes.value ==undefined?'':inputRadioDom[i].attributes.value.value;
				formRadioElements.required = inputRadioDom[i].attributes.isrequired == undefined?'':inputRadioDom[i].attributes.isrequired.value == true;
                formRadioElements.contentGridCol = inputRadioDom[i].attributes.col == undefined?'':inputRadioDom[i].attributes.col.value;
                if(' '!=inputRadioDom[i].attributes.orgname.value){
                    for(var j= 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == inputRadioDom[i].attributes.orgname.value){
                            formRadioElements.label = window.labelArr[j].text;
                            formRadioElements.labelGridCol = $("#"+inputRadioDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                elementList.push(formRadioElements);
			}
		}
		var formCheckBoxElements;
		if(inputCheckBoxDom.length > 0){
			for(var i  = 0;i<inputCheckBoxDom.length;i++){
				formCheckBoxElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:''
				}
				formCheckBoxElements.eleType = 'checkbox';
				formCheckBoxElements.name = inputCheckBoxDom[i].attributes.name == undefined ?'':inputCheckBoxDom[i].attributes.name.value;
				//formCheckBoxElements.label = inputCheckBoxDom[i].attributes.title == undefined?'':inputCheckBoxDom[i].attributes.title.value;
				formCheckBoxElements.value = inputCheckBoxDom[i].attributes.value ==undefined?'':inputCheckBoxDom[i].attributes.value.value;
				formCheckBoxElements.required = inputCheckBoxDom[i].attributes.isrequired == undefined?'':inputCheckBoxDom[i].attributes.isrequired.value == true;
                formCheckBoxElements.contentGridCol = inputCheckBoxDom[i].attributes.col == undefined?'':inputCheckBoxDom[i].attributes.col.value;
                if(' '!=inputCheckBoxDom[i].attributes.orgname.value){
                    for(var j = 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == inputCheckBoxDom[i].attributes.orgname.value){
                            formCheckBoxElements.label = window.labelArr[j].text;
                            formCheckBoxElements.labelGridCol = $("#"+inputCheckBoxDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                elementList.push(formCheckBoxElements);
			}
        }
        var formTimeElements;
		if(inputTimeBoxDom.length > 0){
			for(var i  = 0;i<inputTimeBoxDom.length;i++){
				formTimeElements = {
					eleType:'',
					labelGridCol:0,
					name:'',
					label:'',
					contentGridCol:0,
					value:'',
					content:'',
					required:''
				}
				formTimeElements.eleType = inputTimeBoxDom[i].attributes.type.value;
				formTimeElements.name = inputTimeBoxDom[i].attributes.name == undefined ?'':inputTimeBoxDom[i].attributes.name.value;
				//formTimeElements.label = inputTimeBoxDom[i].attributes.title == undefined?'':inputTimeBoxDom[i].attributes.title.value;
				formTimeElements.value = inputTimeBoxDom[i].attributes.value ==undefined?'':inputTimeBoxDom[i].attributes.value.value;
				formTimeElements.required = inputTimeBoxDom[i].attributes.isrequired == undefined?'':inputTimeBoxDom[i].attributes.isrequired.value == true;
				//formTimeElements.labelGridCol = inputTimeBoxDom[i].attributes.labelcol == undefined?'':inputTimeBoxDom[i].attributes.labelcol.value;
				formTimeElements.contentGridCol = inputTimeBoxDom[i].attributes.col == undefined?'':inputTimeBoxDom[i].attributes.col.value;
                if(' '!=inputTimeBoxDom[i].attributes.orgname.value){
                    for(var j = 0;j<window.labelArr.length;j++){
                        if(window.labelArr[j].value == inputTimeBoxDom[i].attributes.orgname.value){
                            formTimeElements.label = window.labelArr[j].text;
                            formTimeElements.labelGridCol = $("#"+inputTimeBoxDom[i].attributes.orgname.value).attr("col");
                        }
                    }
                }
                elementList.push(formTimeElements);
			}
        }
        if(elementList.length > 0 ){
            fromEle.formElements.push(elementList);
            console.log(fromEle);
			$("#toJsonModal textarea").val(formatJson(fromEle));
		}
    });
    function formatJson(json, options) {
        var reg = null,
            formatted = '',
            pad = 0,
            PADDING = '    '; 
        options = options || {};
        options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true) ? true : false;
        options.spaceAfterColon = (options.spaceAfterColon === false) ? false : true;
        if (typeof json !== 'string') {
            json = JSON.stringify(json);
        }
        json = JSON.parse(json);
        json = JSON.stringify(json);
        reg = /([\{\}])/g;
        json = json.replace(reg, '\r\n$1\r\n');
        reg = /([\[\]])/g;
        json = json.replace(reg, '\r\n$1\r\n');
        reg = /(\,)/g;
        json = json.replace(reg, '$1\r\n');
        reg = /(\r\n\r\n)/g;
        json = json.replace(reg, '\r\n');
        reg = /\r\n\,/g;
        json = json.replace(reg, ',');
        if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
            reg = /\:\r\n\{/g;
            json = json.replace(reg, ':{');
            reg = /\:\r\n\[/g;
            json = json.replace(reg, ':[');
        }
        if (options.spaceAfterColon) {
            reg = /\:/g;
            json = json.replace(reg, ': ');
        }
        $.each(json.split('\r\n'), function(index, node) {
            var i = 0,
                indent = 0,
                padding = '';
            if (node.match(/\{$/) || node.match(/\[$/)) {
                indent = 1;
            } else if (node.match(/\}/) || node.match(/\]/)) {
                if (pad !== 0) {
                    pad -= 1;
                }
            } else {
                indent = 0;
            }
    
            for (i = 0; i < pad; i++) {
                padding += PADDING;
            }
    
            formatted += padding + node + '\r\n';
            pad += indent;
        });
        return formatted;
    };
    $("#download").click(function () {
        downloadLayout();
        return false
    });
    $("#downloadhtml").click(function () {
        downloadHtmlLayout();
        return false
    });
    $("#edit").click(function () {
        $("body").removeClass("devpreview sourcepreview");
        $("body").addClass("edit");
        removeMenuClasses();
        $(this).addClass("active");
        return false
    });
    $("#clear").click(function (e) {
        e.preventDefault();
        clearDemo()
    });
    $("#devpreview").click(function () {
        $("body").removeClass("edit sourcepreview");
        $("body").addClass("devpreview");
        removeMenuClasses();
         $(this).addClass("active");
        return false
    });
    $("#sourcepreview").click(function () {
        $("body").removeClass("edit");
        $("body").addClass("devpreview sourcepreview");
        removeMenuClasses();
        $(this).addClass("active");
        return false
    });
    $(".nav-header").click(function () {
        $(".sidebar-nav .boxes, .sidebar-nav .rows").hide();
        $(this).next().slideDown()
    });
    $(".addTR").click(function(){
		$('#addTR').modal('show');
		$('#addTR input').val(' ');
    });
    $(".addRadio").click(function(){
		$('#addRadio').modal('show');
		$('#addRadio input').val(' ');
    });
    $(".addCheckbox").click(function(){
		$('#addCheckbox').modal('show');
		$('#addCheckbox input').val(' ');
    });
    var index =0;
    $(".saveCheckboxVal").click(function(){
		var fieldName = $(".checkValForm .fieldname").val();
		var orgName = $(".checkValForm .orgname").val();
		var isReq = $(".checkValForm .isReq").val();
		var isReqText = 'Y'==isReq?"是":"否";
		var html = '<tr id="'+index+'"><td>'+fieldName+'</td><td>'+orgName+'</td><td value='+isReq+'>'+isReqText+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
		index++;
        $("#checkForm table tbody").append(html)
        $('#addCheckbox').modal('hide');
	})
    $(".saveRadioVal").click(function(){
		var fieldName = $(".radioValForm .fieldname").val();
		var orgName = $(".radioValForm .orgname").val();
		var isReq = $(".radioValForm .isReq").val();
		var isReqText = 'Y'==isReq?"是":"否";
		var html = '<tr id="'+index+'"><td>'+fieldName+'</td><td>'+orgName+'</td><td value='+isReq+'>'+isReqText+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
		index++;
        $("#radioForm table tbody").append(html);
        $('#addRadio').modal('hide');
	})
    $(".saveAddTr").click(function(){
		var fieldName = $("#selectValForm .fieldname").val();
        var orgName = $("#selectValForm .orgname").val();
        if(' '!=fieldName && ' '!=orgName){
            var html = '<tr id="'+index+'"><td>'+fieldName+'</td><td>'+orgName+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
            index++;
            $("#selectForm table tbody").append(html);
            $('#addTR').modal('hide');
        }else{
            $("#addTR .topinfo .info").html('请输入下拉选择数据！');
            $("#addTR .topinfo").removeClass('hide');
        }
    });
    $("#selectForm table").on('click','button',function(e){
		$("#"+$(this).parent().parent()[0].id).remove();
    });
    $("#radioForm table").on('click','button',function(e){
		$("#"+$(this).parent().parent()[0].id).remove();
    });
    $("#checkForm table").on('click','button',function(e){
		$("#"+$(this).parent().parent()[0].id).remove();
	})
    var layouteditor = '';
    $('body.edit .demo').on("click","[data-target=#editorLayout],[data-target=#editorTitle],[data-target=#editorInputModal],[data-target=#editorSelectModal],[data-target=#editorTextareaModal],[data-target=#editorRadioModal],[data-target=#editorCheckboxModal],[data-target=#editorDateTimeModal]",function(e) {
        /**布局绘制  start*/
        layouteditor = $(this).parent().parent().find('.view');
        window.layoutEditor = layouteditor;
        /**布局绘制  end*/
        /**标题  start*/
        var titleEdit = $(this).parent().parent().parent().find('.view');
        window.titleEdit = titleEdit;
        /**标题  end*/
        var domType = $($(this).parent().parent().parent().find('.view').children().children()).attr('type');
        var dom = $(this).parent().parent().parent().find('.view').children().children();
        window.domClick = dom;
        console.log(domType);
        if('text'==domType){
            $("#editorInputModal input[name=fieldname]").val(dom.attr('fieldname'));
            //$("#editorInputModal input[name=orgname]").val(dom.attr('orgname'));
            $("#editorInputModal select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
			$("#editorInputModal input[name=orgvalue]").val(dom.attr('value'));
            $("#editorInputModal .isRequired").find("option[value='"+dom.attr('isRequired')+"']").prop("selected",true);
            $("#editorInputModal .orgtype").find("option[value='"+dom.attr('orgtype')+"']").prop("selected",true);
        }else if('select'==domType){
            $("#selectForm input[name=fieldname]").val(dom.attr('fieldname'));
            //$("#selectForm input[name=orgname]").val(dom.attr('orgname'));
            $("#selectForm select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
            $("#selectForm .isRequired").find("option[value='"+dom.attr('isRequired')+"']").prop("selected",true);
			var optionHtml = ' ';
			var index = 0;
			$(dom).find("option").each(function(){
				optionHtml += '<tr id="'+index+'"><td>'+$(this).eq(0).html()+'</td><td>'+$(this).eq(0).val()+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
				index++;
			});
			$("#selectForm table tbody").html(optionHtml);
        }else if('textarea' == domType){
            $("#textareaForm input[name=fieldname]").val(dom.attr('fieldname'));
           // $("#textareaForm input[name=orgname]").val(dom.attr('orgname'));
            $("#textareaForm select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
			$("#textareaForm .isRequired").find("option").prop("selected",false);
			$("#textareaForm .isRequired").find("option[value='"+dom.attr('isRequired')+"']").prop("selected",true);
        }else if('radio' == domType){
            $("#radioForm input[name=fieldname]").val(dom.attr('name'));
            //$("#radioForm input[name=orgname]").val(dom.attr('title'));
            $("#radioForm select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
			var index = 0;
			var isReq = '';
			var html = '';
			var isReqText = '';
			$(dom.parent()).find("label").each(function(){
				if(''!=$(this).eq(0).html() && ''!=$(this).eq(0).next().val() && ''!=$(this).eq(0).next().attr("checked")){
                    var isChecked = $(this).eq(0).next().attr("checked");
					if('checked' == isChecked){
						isReq = 'Y';
						isReqText = '是';
					}else{
						isReq = 'N';
						isReqText = '否';
					}
					html += '<tr id="'+index+'"><td>'+$(this).eq(0).html()+'</td><td>'+$(this).eq(0).prev().val()+'</td><td value='+isReq+'>'+isReqText+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
					index++;
				}
			});
			$("#radioForm table tbody").html(html);
        }else if('checkbox' == domType){
			$("#checkForm input[name=fieldname]").val(dom.attr('name'));
            //$("#checkForm input[name=orgname]").val(dom.attr('title'));
            $("#checkForm select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
			var index = 0;
			var isReq = '';
			var html = '';
			var isReqText = '';
			$(dom.parent()).find("label").each(function(){
				if(''!=$(this).eq(0).html() && ''!=$(this).eq(0).next().val() && ''!=$(this).eq(0).next().attr("checked")){
					var isChecked = $(this).eq(0).next().attr("checked");
					if('checked' == isChecked){
						isReq = 'Y';
						isReqText = '是';
					}else{
						isReq = 'N';
						isReqText = '否';
					}
					html += '<tr id="'+index+'"><td>'+$(this).eq(0).html()+'</td><td>'+$(this).eq(0).prev().val()+'</td><td value='+isReq+'>'+isReqText+'</td><td><button type="button" class="btn btn-danger btn-xs removeTr" >删除</button></td></tr>';
					index++;
				}
			});
			$("#checkForm table tbody").html(html);
        }else if('date,time,datetime-local,month,week'.indexOf(domType)!=-1){
            $("#dateTimeForm input[name=fieldname]").val(dom.attr('name'));
            //$("#dateTimeForm input[name=orgname]").val(dom.attr('title'));
            $("#dateTimeForm select[name=orgname]").find("option[value='"+dom.attr('orgname')+"']").prop("selected",true);
            $("#dateTimeForm .isRequired").find("option").prop("selected",false);
            $("#dateTimeForm .isRequired").find("option[value='"+dom.attr('isRequired')+"']").prop("selected",true);
            $("#dateTimeForm .type").find("option[value='"+dom.attr('type')+"']").prop("selected",true);
		}else if('label' == domType){
            $("#editorTitle .title").val(dom.attr('title'));
        }
    });
    $(".savecontent").click(function(){
        var nameFlag = $(this).data("name");
        console.log(window.isUEditor);
        var div;
        var dom;
        if(!window.isUEditor){
             div = dom.parent();
             dom = window.domClick;
        }else{
            dom = window.domClick.target;
        }
        if('data-input' == nameFlag){
            var serializeArray ;
            if(window.isUEditor){
                serializeArray = $('#editorInputTableModal #inputForm').serializeArray();
            }else{
                serializeArray = $('#editorInputModal #inputForm').serializeArray();
            }
            for(var i = 0;i<serializeArray.length;i++){
                if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				if('orgvalue' == serializeArray[i].name){
					$(dom).attr('value',serializeArray[i].value);
				}
				if('orgtype' == serializeArray[i].name){
					$(dom).attr('orgtype',serializeArray[i].value);
                }
                if('isRequired' == serializeArray[i].name){
					if('Y' == serializeArray[i].value){
						$(div).addClass('has-error');
					}else if('N' == serializeArray[i].value){
						$(div).removeClass('has-error');
					}
				}
                $(dom).attr(serializeArray[i].name,serializeArray[i].value);
            }
            $("#editorInputModal").modal('hide');  //手动关闭
            $("#editorInputTableModal").modal('hide');  //手动关闭
            window.isUEditor = false;
        }else if('data-select' == nameFlag){
                var id;
                if(window.isUEditor){
                    id = 'editorSelectTableModal';
                }else{
                    id = 'editorSelectModal';
                }
                var   serializeArray = $('#'+id+' #selectForm').serializeArray();
				for(var i = 0;i<serializeArray.length;i++){
					if('fieldname' == serializeArray[i].name){
						$(dom).attr('id',serializeArray[i].value);
						$(dom).attr('fieldname',serializeArray[i].value)
					}
					if('orgname' == serializeArray[i].name){
						$(dom).attr('title',serializeArray[i].value);
					}
					if('isRequired' == serializeArray[i].name){
						if('Y' == serializeArray[i].value){
							$(div).addClass('has-error');
						}else if('N' == serializeArray[i].value){
							$(div).removeClass('has-error');
						}
					}
					$(dom).attr(serializeArray[i].name,serializeArray[i].value)
				}
				var optionHtml = ' ';
				$("#"+id+" #selectForm table tbody").find("tr").each(function(){
					optionHtml +='<option value="'+$(this).find("td").eq(1).html()+'" >'+$(this).find("td").eq(0).html()+'</option>';
                });
                $(dom).html(optionHtml);
                $("#editorSelectModal").modal('hide');  //手动关闭
                $("#editorSelectTableModal").modal('hide');  //手动关闭
                window.isUEditor = false;
        }else if('data-textarea' == nameFlag){
                var id;
                if(window.isUEditor){
                    id = 'editorTextareaTableModal';
                }else{
                    id = 'editorTextareaModal';
                }
            var serializeArray = $('#'+id+' #textareaForm').serializeArray();
			for(var i = 0;i<serializeArray.length;i++){
				if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				if('orgvalue' == serializeArray[i].name){
					$(dom).attr('value',serializeArray[i].value);
				}
				if('isRequired' == serializeArray[i].name){
					if('Y' == serializeArray[i].value){
						$(div).addClass('has-error');
					}else if('N' == serializeArray[i].value){
						$(div).removeClass('has-error');
					}
				}
				$(dom).attr(serializeArray[i].name,serializeArray[i].value)
            }
            $("#editorTextareaModal").modal('hide');  //手动关闭
            $("#editorTextareaTableModal").modal('hide');  //手动关闭
            window.isUEditor = false;
        }else if('data-radio' == nameFlag){
            var serializeArray = $('#editorRadioModal #radioForm').serializeArray();
			for(var i = 0;i<serializeArray.length;i++){
				if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				$(dom).attr(serializeArray[i].name,serializeArray[i].value)
			}
			var radioHtml = '';
			$("#radioForm table tbody").find("tr").each(function(){
				if('是' == $(this).find("td").eq(2).html()){
					radioHtml +='<input title='+$(dom).attr('title')+'col="'+$(dom).attr('col')+'" orgname="'+$(dom).attr('orgname')+'" id="'+$(dom).attr('id')+'" name='+$(dom).attr('name')+' type="radio" checked value='+$(this).find("td").eq(1).html()+'><label class="radioLabelEdit" for="name">'+$(this).find("td").eq(0).html()+'</label>';
				}else{
					radioHtml +='<input title='+$(dom).attr('title')+' col="'+$(dom).attr('col')+'" orgname="'+$(dom).attr('orgname')+'" id="'+$(dom).attr('id')+'" name='+$(dom).attr('name')+' type="radio" value='+$(this).find("td").eq(1).html()+'><label class="radioLabelEdit" for="name">'+$(this).find("td").eq(0).html()+'</label>';
				}
			});
			if(''!= radioHtml ){
				$(dom.parent()).html(radioHtml);
            }
            $("#editorRadioModal").modal('hide');  //手动关闭
        }else if('data-check' == nameFlag){
            var serializeArray = $('#editorCheckboxModal #checkForm').serializeArray();
			for(var i = 0;i<serializeArray.length;i++){
				if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				$(dom).attr(serializeArray[i].name,serializeArray[i].value)
			}
			var radioHtml = '';
			$("#checkForm table tbody").find("tr").each(function(){
				if('是' == $(this).find("td").eq(2).html()){
					radioHtml +='<input title='+$(dom).attr('title')+' col="'+$(dom).attr('col')+'" orgname="'+$(dom).attr('orgname')+'" id="'+$(dom).attr('id')+'" name='+$(dom).attr('name')+' type="checkbox" checked value='+$(this).find("td").eq(1).html()+'><label class="radioLabelEdit" for="name">'+$(this).find("td").eq(0).html()+'</label>';
				}else{
					radioHtml +='<input title='+$(dom).attr('title')+' col="'+$(dom).attr('col')+'" orgname="'+$(dom).attr('orgname')+'" id="'+$(dom).attr('id')+'" name='+$(dom).attr('name')+' type="checkbox" value='+$(this).find("td").eq(1).html()+'><label class="radioLabelEdit" for="name">'+$(this).find("td").eq(0).html()+'</label>';
				}
			});
			if(''!= radioHtml){
				$(dom.parent()).html(radioHtml);
            }
            $("#editorCheckboxModal").modal('hide');  //手动关闭
        }else if('data-date' == nameFlag){
            var serializeArray = $('#editorDateTimeModal #dateTimeForm').serializeArray();
			for(var i = 0;i<serializeArray.length;i++){
				if('fieldname' == serializeArray[i].name){
					$(dom).attr('id',serializeArray[i].value);
					$(dom).attr('name',serializeArray[i].value)
				}
				if('orgname' == serializeArray[i].name){
					$(dom).attr('title',serializeArray[i].value);
				}
				if('isRequired' == serializeArray[i].name){
					if('Y' == serializeArray[i].value){
						$(div).addClass('has-error');
					}else if('N' == serializeArray[i].value){
						$(div).removeClass('has-error');
					}
				}
                $(dom).attr(serializeArray[i].name,serializeArray[i].value);
                $("#editorDateTimeModal").modal('hide');  //手动关闭
			}
        }
    });
    $(".saveTitle").click(function(e){
        var _titleEdit = window.titleEdit;
        var _textareaVal = $("#editorTitle .title").val();
        var _id = $(_titleEdit.children().children()).attr('id');
        if(undefined!=_textareaVal && ''!=_textareaVal){
            $(_titleEdit.children().children()).attr('title',_textareaVal);
            $(_titleEdit.children().children()).attr('id',undefined == _id?Math.ceil(Math.random()*1000):_id);
            $(_titleEdit.children().children()).text(_textareaVal);
            $("#editorTitle").modal('hide');  //手动关闭
        }else{
            $("#editorTitle .topinfo .info").html('请输入标题内容');
            $("#editorTitle .topinfo").removeClass('hide');
        }
        var $demo = $(".demo");
        var optionHtml='<option value=" ">请选择</option>';
        var optionMap;
        var labelArr = [];
        $demo.find('label').each(function(e){
            if(undefined != $(this).attr('id') && undefined != $(this).attr('title')){
                optionMap = {value:'',text:''};
                optionHtml +='<option value="'+$(this).attr('id')+'" >'+$(this).attr('title')+'</option>';
                optionMap.value = $(this).attr('id');
                optionMap.text = $(this).attr('title');
                labelArr.push(optionMap);
            }
        });
        window.labelArr = labelArr;
        $("#editorInputModal select[name=orgname]").html(optionHtml);
        $("#editorSelectModal select[name=orgname]").html(optionHtml);
        $("#editorTextareaModal select[name=orgname]").html(optionHtml);
        $("#editorRadioModal select[name=orgname]").html(optionHtml);
        $("#editorCheckboxModal select[name=orgname]").html(optionHtml);
        $("#editorDateTimeModal select[name=orgname]").html(optionHtml);
    });
    $(".saveLayout").click(function(e){
        var _layouteditor = window.layoutEditor;
        var layoutCol = $("#editorLayout .layoutCol").val();
        var inputDom = $("#editorLayout .ratio input");
        if(layoutCol <= 12){
            var _result = 0;
            var _strResult='';
            for(var i = 0;i<inputDom.length;i++){
                _result+=parseInt($(inputDom[i]).val());
                _strResult+=$(inputDom[i]).val()+',';
            }
            if(_result <= 12){
                var _div='';
                var resultArr = _strResult.split(',');
                for(var i = 0;i<resultArr.length;i++){
                    if('' != resultArr[i]){
                        _div +='<div class="col-md-'+resultArr[i]+' column ui-sortable"></div>';
                    }
                }
                if(_result < 12){
                    var _remain = 12 - _result;
                    _div+='<div class="col-md-'+_remain+' column ui-sortable"></div>';
                }
                _layouteditor.children().html(_div);
                $(".demo .column").sortable({
                    opacity: .35,
                    connectWith: ".column"
                })
                $("#editorLayout").modal('hide');  //手动关闭
            }else{
                $(".topinfo .info").html('您输入的总比例'+_result+',已超出范围!');
                $("#editorLayout .topinfo").removeClass('hide');
            }
        }else{
            $("#editorLayout .topinfo .info").html('您输入了'+layoutCol+'列,已超出范围!');
            $("#editorLayout .topinfo").removeClass('hide');
        }

    })
    $("#editorLayout .layoutCol").bind("input propertychange",function(event){
        var fistInput = '<input type="number" class="form-control " style="width:7%;" value="1" min="1" max="12" step="1" >';
        var twoInput =  '<input type="number" class="form-control modal-input-number"  value="1" min="1" max="12" step="1" >';
        var appendInput = '<input type="number" class="form-control modal-input-numberNext"  value="1" min="1" max="12" step="1" >';
        var col = $(this).val();
        if(col <= 12){
            if(col ==1){
                $("#editorLayout .ratio").html(fistInput);
            }else if(col ==2){
                $("#editorLayout .ratio").html(fistInput+twoInput);
            }else if(col ==3){
                $("#editorLayout .ratio").html(fistInput+twoInput+appendInput);
            }else if(col == 4){
                var _appendInput = '';
                for(var i = 0;i<4-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==5){
                var _appendInput = '';
                for(var i = 0;i<5-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==6){
                var _appendInput = '';
                for(var i = 0;i<6-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==7){
                var _appendInput = '';
                for(var i = 0;i<7-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==8){
                var _appendInput = '';
                for(var i = 0;i<8-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==9){
                var _appendInput = '';
                for(var i = 0;i<9-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==10){
                var _appendInput = '';
                for(var i = 0;i<10-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==11){
                var _appendInput = '';
                for(var i = 0;i<11-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }else if(col ==12){
                var _appendInput = '';
                for(var i = 0;i<12-2;i++){
                    _appendInput+=appendInput;
                }
                $("#editorLayout .ratio").html(fistInput+twoInput+_appendInput);
            }
            
        }
    });
    $(".UEditorclick").click(function(){
        console.log('UEditorclick');
        var insertDom = $(this).parent().find(".view").children();
        if('text' == insertDom.children().attr("type") || 'textarea' == insertDom.children().attr("type")){
            $(insertDom.children()).removeClass('default');
            $(insertDom.children()).css("width","98%");
        }
        var $UEditorTextarea = $(".demo").find("textarea");
        if($UEditorTextarea.length > 0){
            $UEditorTextarea.each(function(e){
                if('text/plain' == $(this).attr("type")){
                    var id =  $(this).prev().attr("id");
                    if(id ==  window.UEditorId){
                        UE.getEditor(id).focus();
                        UE.getEditor(id).execCommand('insertHtml',insertDom.html());
                    }
                }
            })
        }
    });
    removeElm();
    configurationElm();
    gridSystemGenerator();
    setInterval(function () {
        handleSaveLayout()
    }, timerSave)
})